\chapter{Appearance Computations}
\label{chap:appearance}

So far, we've covered the fundamental basics of the light and the rendering process to be able to comprehend the more advanced techniques practiced in the computer graphics. As we've mentioned before, our primary goal is to evaluate the computational accuracy of several specific appearance sensations. Even though they are quite common in every day life, their integration to the modern renderers is, to this date, rare.  In this chapter, we discuss these phenomena individually --- their manifestations in the nature, the physics behind them and finally, their computations in the rendering process. 

\section{Reflectance}

The reflective surfaces are a surprisingly common sighting. As the perfectly diffuse materials basically do not exist in the nature, a large set of the materials that surround us are considered glossy. In \autoref{sec:BRDF}, we defined a bidirectional reflectance distribution function that defines the reflective properties of a material. 

\subsection{Fresnel equations}

It is necessary to know the basics of the geometry optics to be able to properly define a reflectance model. First of all, the \emph{Snell's law}~\cite{pharr2016physically}

\begin{equation}
\eta_i sin\theta_i = \eta_t sin\theta_t 
\end{equation}

states that the incoming angle $\theta_i$ (angle between the surface normal and the incoming direction) times the \emph{index of refraction} of the entering medium $\eta_i$ must be equal to their transmitted counterparts. In other words, knowing the indices of refraction of the entering and the leaving media and the incoming direction, we can compute the transmitted direction.

The index of refraction (IOR) varies from material to material (e.g. IOR of glass is \~1.5) and it essentially states how fast the light travels through the specific material.

However, this gives us only the direction of the refracted light. In most cases, we also need to know the ratio between the reflected and the refracted light. Depending on the polarization of the light (further explained in \autoref{sec:polarization}), the \emph{Fresnel equations} take the two following forms~\cite{pharr2016physically}:

\begin{align*}
r_s = \frac{\eta_t cos\theta_i - \eta_i cos\theta_t}{\eta_t cos\theta_i + \eta_i cos\theta_t}\\
r_p = \frac{\eta_i cos\theta_i - \eta_t cos\theta_t}{\eta_i cos\theta_i + \eta_t cos\theta_t} 
\end{align*}

From these, we can compute the \emph{Fresnel reflectance} for an unpolarized light:
\begin{equation}
F_r=\frac{1}{2}(r_s^2 + r_p^2)
\end{equation}

The transmitted energy is equal to $1-F_R$ due to the energy conservation law.

Note that the previous computations describe only a subset of the materials called the \emph{dielectrics}, which are the materials that do not conduct electricity and are capable of transmitting light, such as glass, water, diamond, etc. The second large group consists of the \emph{conductors} which are basically all metals/materials with opaque surfaces. The light is actually transmitted into the conductor, however, due to its physical properties, it is quickly absorbed. There exists a third group of the \emph{semiconductors} which are very rarely considered in the physically based rendering, therefore we skip them. A comparison between a dielectric and a conductor is shown in \autoref{fig:compare_dielectric_conductor}.

\begin{figure}[h]
	\centering
	\begin{tabular}{cc}
		\includegraphics[width=.4\linewidth]{img/dielectric_diamond.jpg}
		&
		\includegraphics[width=.4\linewidth]{img/conductor_aluminium.jpg}
	\end{tabular}
	\caption{A preview of a dielectric (diamond, left) a  conductor (aluminium, right) rendered in Mitsuba2~\cite{mitsubaWeb}}
	\label{fig:compare_dielectric_conductor}
\end{figure}

While this is a matter of simply computing the Fresnel equations, the practice is more complicated as most of the commonly seen materials are not perfectly smooth. Slight imperfections, either on purpose or due to the manufacturing errors, can be found on a large majority of all materials which makes them rough.

\subsection{Microfacet theory}
With that in mind, the \emph{microfacet theory} was developed by \citet{cook1982reflectance} to address this aspect and provide a theoretical representation of the rough surfaces.

The main idea is that a rough surface consists of the \emph{microfacets} -- a collection of very small surfaces distributed statistically throughout the whole underlying \emph{macrosurface}. We compute the illumination (BRDF) for each of these microfacets (commonly considered to be a perfect mirror) and their aggregate behavior states the final scattering. An example of such distribution is shown in \autoref{fig:microfacets}.

\begin{figure}[h]
	\centering
	\includegraphics[width=.8\linewidth]{img/microfacets.pdf}
	\caption{A demonstration of a very rough (left) and a relatively smooth (right) microfacet distribution~\cite{pharr2016physically}}
	\label{fig:microfacets}
\end{figure}

As these microfacet computations are local, we need to consider the possibility that they might obscure each other. Three main aspects are accounted for:
\begin{description}
	\item[Masking] Microfacet is not visible from the viewer
	\item[Shadowing] Microfacet is not reachable from the light source
	\item[Interrecflection] Bounces between the microfacets
\end{description}

Many variations to the Cook-Torrance model have been developed, such as it's predecessor Torrance-Sparrow~\cite{Torrance1967TheoryFO} or Oren-Nayar~\cite{oren1994generalization} for diffuse reflectance.

In this thesis, we focus on the distribution functions of the microfacets as they are ultimately the deciding factor of the rough surface look. A nice comparison of the three commonly used microfacet distributions --- \emph{Phong}, \emph{Beckmann} and \emph{GGX} -- along with their distribution functions, masking functions and sampling equations can be found in the \citet{walter2007microfacet}. As the exact formulations of those three methods are not a necessity for this thesis, we provide only a brief overview for each of them and an illustrative comparison between the GGX and the Beckmann of the same roughness in 
\autoref{fig:ggx_beckmann}.

\paragraph{Phong}

Even though the Phong distribution is purely empirical (not physically based), it is still quite popular choice for the microfacet distribution as it is simple to implement and provides sufficient results.

\paragraph{Beckmann}

The Beckmann distribution~\cite{beckmann1987scattering} is already physically based and for a long time has been considered the best solution to the rough surfaces as it is based on the Gaussian roughness. However, with the parameters set appropriately, it still provides the results very similar to the Phong distribution.

\paragraph{GGX}

The GGX distribution~\cite{walter2007microfacet} was introduced as an improvement over the Beckmann's solution for some cases. It maintains stronger tails, thus better shadowing and is based on the measured data of the real rough materials.

\begin{figure}[h]
	\centering
	\includegraphics[width=.8\linewidth]{img/ggx_beckmann.png}
	\caption{A rough aluminium sphere with the GGX distribution (left) compared to it's Beckmann equivalent (right) rendered  in Mitsuba2}
	\label{fig:ggx_beckmann}
\end{figure}

\section{Polarization}
\label{sec:polarization}

Similarly to all kinds of the electromagnetic radiation, the light also propagates through space as a wave. The oscillation direction of this wave neither defines nor modifies the color of the light but it makes the light behave differently upon an interaction with certain materials. \autoref{fig:oscillation} explains the different directions of a wave.

\begin{figure}[h]
	\centering
	\includegraphics[width=.6\linewidth]{img/oscillation.pdf}
	\caption{Demonstration of the direction of oscillation and the direction propagation}
	\label{fig:oscillation}
\end{figure}

In the light's natural state (sun, common light bulb), the directions of it's oscillation are arbitrary --- such light is called \emph{unpolarized}. The \emph{polarized} light maintains a restricted direction of oscillation and it is a result of a \emph{polarization} process. Note that the light is often only partially polarized as the restriction of the direction does not have to be perfect and allows some variations.

Depending on the shape of their electric fields, we distinguish three types of polarization which are demonstrated in \autoref{fig:polar_types}.

\begin{figure}[h]
	\centering
	\includegraphics[width=.7\linewidth]{img/polar_types.png}
	\caption[polar types]{An illustrative demonstration of the different types of polarization \footnotemark}
	\label{fig:polar_types}
\end{figure}
\footnotetext{\url{http://hyperphysics.phy-astr.gsu.edu/hbase/phyopt/polclas.html}}

To create a linearly polarized light, one may put a dielectric object in the direction of propagation of an unpolarized light. Due to the optical properties of the dielectrics, the reflected and the transmitted light will be polarized proportionally to the angle of the incidence. The angle at which the reflected light is perfectly polarized is called the \emph{Brewster's angle}~\cite{brewster1815laws}. It is computed by the following formula:

\begin{equation}
\theta=arctan(\frac{n_2}{n_1})
\end{equation}
, where $n_1$ is the IOR of the incident medium and $n_2$ of the transmitted medium.

In this case, we distinguish two types of the linearly polarized light depending on their orientation to the incident plane. The reflected light is called \emph{p-polarized} as its oscillation is parallel to the plane of incidence. The transmitted light is called \emph{s-polarized} as its oscillation is perpendicular (from the German word) to the plane of incidence. Both are shown in \autoref{fig:brewster}.

\begin{figure}[h]
	\centering
	\includegraphics[width=.7\linewidth]{img/brewster.pdf}
	\caption{Prefectly p-polarized reflected and partially s-polarized light refracted from a dielectric interface at the Brewster's angle}
	\label{fig:brewster}
\end{figure}


The principle of Brewster's angle is used in a material called the \emph{polarizer}. As the name suggests, it polarizes the light, restricting it's direction of oscillation accordingly the specifics of the polarizer. If the light that passes through the polarizer is of the opposite (perpendicular) direction to the polarizer's transmission orientation, it won't let it through and no light is visible. \autoref{fig:polarizer} illustrates the effects of a polarizer.

\begin{figure}[h]
	\centering
	\includegraphics[width=.6\linewidth]{img/polarizer.png}
	\caption[nikon]{Unpolarized light passes through a vertical polarizer $\rightarrow$ linearly vertically polarized light passes through a horizontal polarizer $\rightarrow$ no light\footnotemark}
	\label{fig:polarizer}
\end{figure}
\footnotetext{\url{https://www.apioptics.com/about-api/resources/visible-light-linear-polarizer/}}

This property is frequently incorporated in the sunglasses or camera filters to reduce the glare of the sun reflected from a horizontal surface. The reflected p-polarized light goes through a polarizer with a perpendicularly oriented transmission axis which consequently eliminates the incoming light. The effect of a polarizing filter is shown in \autoref{fig:polarizer_nikon}.

\begin{figure}[h]
	\centering
	\includegraphics[width=.7\linewidth]{img/polarizer_nikon.jpg}
	\caption[nikon]{Polarizing filter by Nikon\footnotemark}
	\label{fig:polarizer_nikon}
\end{figure}
\footnotetext{\url{https://www.nikonusa.com/en/learn-and-explore/a/tips-and-techniques/polarizing-filters-add-pow-to-pictures.html}}

As the polarization is a vast topic, we do not need to go into further detail for the purposes of this thesis. If the reader wishes to learn more, please refer to a scientific literature, for example \citet{kliger2012polarized}

\subsection{Polarization in rendering}
The integration of the polarization in the rendering process is quite rare. Only a few scenarios display the effects of the polarization and one must implement quite complex behavior of the radiation waves. However, renderers such as Mitsuba2 or ART fully track the polarization state of light when needed. The implementation covered by this section is already in Mitsuba2~\cite{mitsubaWeb}.

The polarization state is represented by a \emph{Stokes vector} --- a 4-dimensional quantity that fully parameterizes the elliptical shape of the light's electric field for each wavelength separately. The information stored in the Stokes vectors is explained in \autoref{fig:stokes}.

\renewcommand\thesubfigure{\arabic{subfigure}}
\begin{figure}
	\centering
	\begin{tabular}{cc}
		\begin{subfigure}
			{0.4\textwidth}\centering\includegraphics[width=\linewidth]{img/stokes1.png}
			\caption{Radiance - no polarization}
		\end{subfigure}
		&
		\begin{subfigure}
			{0.4\textwidth}\centering\includegraphics[width=\linewidth]{img/stokes2.png}
			\caption{Horizontal vs. vertical polarization}
		\end{subfigure} \\
		\begin{subfigure}
			{0.4\textwidth}\centering\includegraphics[width=\linewidth]{img/stokes3.png}
			\caption{Diagonal polarization}
		\end{subfigure} 
		&
		\begin{subfigure}
			{0.4\textwidth}\centering\includegraphics[width=\linewidth]{img/stokes4.png}
			\caption{Left vs. right circular polarization}
		\end{subfigure}
	\end{tabular}
	\caption{Different information carried by the Stokes vector}
	\label{fig:stokes}
\end{figure}

As we have the polarization states properly represented and we can track them throughout the rendering process, the next step is to determine the affects to these states upon a surface interaction. A transformation between the incoming state and the outgoing state is represented by the \emph{Mueller matrix} $M \in \R^{4x4}$. Due to the adjustments to all interactions in the light transport, we also generalize the BSDF $f_r(\lambda,\omega_i,\omega_o)$ to the polarized pBSDF $M(\lambda,\omega_i,\omega_o)$.

If the  reader is curious about the complications this implementation brings and their solutions, he may want to look into the details of Mitsuba2 in \citet{nimier2019mitsuba}. Nevertheless, they are not crucial for the purposes of this thesis and we purposely skip them.


\section{Dispersion}

\section{Iridescence}


\section{Fluorescence}